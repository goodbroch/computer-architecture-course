---
title: 2.4. Обмен по прерыванию программы
---

## Обмен по прерыванию программы

Этот вид обмена отличается от асинхронного тем, что сигнал готовности ВУ к обмену анализируется не программным, а аппаратным путем. ЭВМ может выполнять любую не связанную с обменом программу (будем называть ее основной), а когда из ВУ по линии "Запрос прерывания" (рис. 1.1) поступит сигнал готовности ВУ к приему или выдаче информации, прервать (приостановить) выполнение этой программы на время выполнения программы обмена данными. Все эти действия осуществляются с помощью контроллера прерываний, входящего в состав устройства управления базовой ЭВМ.

Команды ***EI (Разрешение прерывания)*** и ***DI (Запрещение прерывания)*** переводят контроллер прерываний в одно из двух состояний, в которых он соответственно реагирует или не реагирует на сигналы готовности ВУ, передаваемые по линии "Запрос прерывания". Если контроллер прерываний установлен в состояние разрешения прерывания, то выполняются следующие действия.

***Шаг 1.*** По завершению выполнения текущей команды основной программы управление передается контроллеру прерываний. Если в этот момент на линии "Запрос прерывания" нет сигнала о готовности какого-либо ВУ, то начинается выборка и исполнение следующей команды основной программы и данный шаг повторяется. При наличии запроса прерывания выполняется второй шаг.

***Шаг 2.*** Контроллер прерываний переходит в состояние запрещения прерывания, в ячейку памяти с адресом 000 заносится содержимое СК (адрес следующей команды основной программы, которая выполнялась бы при отсутствии запроса прерывания), и управление передается команде расположенной в ячейке 001. Так происходит переход к подпрограмме обработки прерывания (с первой командой в ячейке 001), функции которой определяются содержанием следующих шагов.

***Шаг 3.*** Производится запоминание в памяти содержимого аккумулятора и регистра переноса. Для этого требуется минимум три команды: пересылка содержимого аккумулятора в специально отведенную буферную ячейку (например, В1), циклический сдвиг содержимого аккумулятора влево (для того, чтобы содержимое регистра переноса попало в аккумулятор) и запись этого содержимого в другую буферную ячейку (например, В2). Таким образом, необходимый минимум информации о прерванной программе сохраняется - в ячейке 000 хранится адрес продолжения прерванной программы, а в ячейках В1 и В2 хранится содержимое двух других основных регистров А и С.

***Шаг 4.*** Производится поиск источника прерывания. Для этого в любой, наиболее целесообразной, последовательности опрашиваются флаги всех ВУ (команда TSF). При обнаружении ВУ с установленным флагом (флаг=1) выполняется переход к тому участку подпрограммы, в котором описаны действия по обмену данными с этим ВУ.

***Шаг 5.*** Выполняется передача данных и их предварительная обработка, если это необходимо. 

***Шаг 6.*** Восстанавливается содержимое регистра переноса и аккумулятора. Для этого требуется минимум пять команд: очистка аккумулятора, вызов содержимого ячейки В2 в очищенный аккумулятор, циклический сдвиг вправо для восстановления содержимого регистра переноса , очистка аккумулятора и вызов содержимого буферной ячейки В1 в очищенный аккумулятор.

***Шаг 7.*** Контроллер прерываний вновь переводится в состояние разрешение прерывания (команда ЕI) и осуществляется возврат к выполнению прерванной программы, т.е. к команде, адрес которой хранится в ячейке 000 (команда BR (0)). Здесь следует отметить, что команда BR () должна располагаться непосредственно за командой ЕI. Иначе при появлении во время обработки прерывания будет стерт (заменен на новый) адрес возврата и путь возврата к прерванной программе будет разрушен.

## Пример 2.2

Составить программу, которая периодически (с периодом в три цикла команды) наращивает на 1 содержимое аккумулятора. Восемь младших разрядов аккумулятора должны выводиться на ВУ-1 по его запросу, а по запросу ВУ-3 код, записанный в регистр данных контроллера ВУ-3, должен помещаться в ячейку 25.

Основная программа решения задачи примера 2.2

<table>
    <thead>
        <tr>
            <th rowspan="2">Адрес</th>
            <th colspan="2">Содержимое</th>
            <th rowspan="2">Комментарий</th>
        </tr>
        <tr>
            <th>Код</th>
            <th>Мнемоника</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>20</td>
            <td>FA00</td>
            <td>EI</td>
            <td>Установка состояния разрешения прерывания</td>
        </tr>
        <tr>
            <td>21</td>
            <td>F200</td>
            <td>CLA</td>
            <td>Очистка аккумулятора</td>
        </tr>
        <tr>
            <td>22</td>
            <td>F800</td>
            <td>INC</td>
            <td rowspan="3">Цикл для наращивания содержимого аккумулятора</td>
        </tr>
        <tr>
            <td>23</td>
            <td>F100</td>
            <td>NOP</td>
            <td></td>
        </tr>
        <tr>
            <td>24</td>
            <td>C022</td>
            <td>BR 22</td>
            <td></td>
        </tr>
        <tr>
            <td>25</td>
            <td>0000</td>
            <td></td>
            <td>Ячейка для хранения кодов, поступающих с ВУ-1</td>
        </tr>
    </tbody>
</table>

Подпрограмма обработки прерываний для примера 2.2 

<table>
    <thead>
        <tr>
            <th rowspan="2">Адрес</th>
            <th colspan="2">Содержимое</th>
            <th rowspan="2">Комментарий</th>
        </tr>
        <tr>
            <th>Код</th>
            <th>Мнемоника</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>00</td>
            <td></td>
            <td></td>
            <td>Ячейка для хранения адреса возврата (этот адрес будет занесен сюда на 2-м шаге)</td>
        </tr>
        <tr>
            <td>01</td>
            <td>C030</td>
            <td>BR 30</td>
            <td>Первая команда подпрограммы - переход к основному ее тексту, размещенному в ячейках 30-4С</td>
        </tr>
        <tr>
            <td>....</td>
            <td>....</td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>30</td>
            <td>304B</td>
            <td>MOV 4B</td>
            <td rowspan="3">Сохранение в буферных ячейках 4В и 4С содержимого аккумулятора и регистра переноса ***(ШАГ 3)***</td>
        </tr>
        <tr>
            <td>31</td>
            <td>F600</td>
            <td>ROL</td>
            <td></td>
        </tr>
        <tr>
            <td>32</td>
            <td>304C</td>
            <td>MOV 4C</td>
        </tr>
        <tr>
            <td>33</td>
            <td>E103</td>
            <td>TSF 3</td>
            <td rowspan="3">Опрос флага ВУ-3. Если он сброшен, то переход к опросу флага ВУ-1. В противном случае переход на ввод данных из ВУ-3</td>
        </tr>
        <tr>
            <td>34</td>
            <td>C036</td>
            <td>BR 36</td>
        </tr>
        <tr>
            <td>35</td>
            <td>C039</td>
            <td>BR 39</td>
            <td></td>
        </tr>
        <tr>
            <td>36</td>
            <td>E101</td>
            <td>TSF 1</td>
            <td rowspan="3">Опрос флага ВУ-1. Если он сброшен, то переход к сбросу флага ВУ-2. В противном случае переход на вывод данных в ВУ-1.</td>
        </tr>
        <tr>
            <td>37</td>
            <td>C043</td>
            <td>BR 43</td>
        </tr>
        <tr>
            <td>38</td>
            <td>C03E</td>
            <td>BR 3E</td>
        </tr>
        <tr>
            <td>39</td>
            <td>F200</td>
            <td>CLA</td>
            <td rowspan="5">Ввод данных из ВУ-3, пересылка их в ячейку 25, сброс флага ВУ-3, переход к восстановлению содержимого основных регистров и выходу из подпрограммы</td>
        </tr>
        <tr>
            <td>3A</td>
            <td>E203</td>
            <td>IN 3</td>
        </tr>
        <tr>
            <td>3B</td>
            <td>E003</td>
            <td>CLF 3</td>
        </tr>
        <tr>
            <td>3C</td>
            <td>3025</td>
            <td>MOV 25</td>
            <td></td>
        </tr>
        <tr>
            <td>3D</td>
            <td>C044</td>
            <td>BR 44</td>
            <td></td>
        </tr>
        <tr>
            <td>3E</td>
            <td>F200</td>
            <td>CLA</td>
            <td rowspan="5">Пересылка в аккумулятор содержимого буферной ячейки 4В, вывод на ВУ-1 восьми младших разрядов аккумулятора, сброс флага ВУ-1, переход восстановлению А и С и выходу из подпрограммы.</td>
        </tr>
        <tr>
            <td>3F</td>
            <td>404B</td>
            <td>ADD 4B</td>
            <td></td>
        </tr>
        <tr>
            <td>40</td>
            <td>E301</td>
            <td>OUT 1</td>
            <td></td>
        </tr>
        <tr>
            <td>41</td>
            <td>E001</td>
            <td>CLF 1</td>
            <td></td>
        </tr>
        <tr>
            <td>42</td>
            <td>C044</td>
            <td>BR 44</td>
            <td></td>
        </tr>
        <tr>
            <td>43</td>
            <td>E002</td>
            <td>CLF 2</td>
            <td>Очистка флага ВУ-2 ***(ШАГ 5)***</td>
        </tr>
        <tr>
            <td>44</td>
            <td>F200</td>
            <td>CLA</td>
            <td rowspan="5">Восстановление содержимого регистра переноса и аккумулятора ***(ШАГ 6)***</td>
        </tr>
        <tr>
            <td>45</td>
            <td>404C</td>
            <td>ADD 4C</td>
            <td></td>
        </tr>
        <tr>
            <td>46</td>
            <td>F700</td>
            <td>ROR</td>
            <td></td>
        </tr>
        <tr>
            <td>47</td>
            <td>F200</td>
            <td>CLA</td>
            <td></td>
        </tr>
        <tr>
            <td>48</td>
            <td>404B</td>
            <td>ADD 4B</td>
            <td></td>
        </tr>
        <tr>
            <td>49</td>
            <td>FA00</td>
            <td>EI</td>
            <td rowspan="2">Возобновление состояния разрешения прерывания и выход из подпрограммы ***(ШАГ 7)***</td>
        </tr>
        <tr>
            <td>4A</td>
            <td>C800</td>
            <td>BR (0)</td>
            <td></td>
        </tr>
        <tr>
            <td>4B</td>
            <td>0000</td>
            <td></td>
            <td rowspan="2">Ячейки для сохранения содержимого аккумулятора и регистра переноса</td>
        </tr>
        <tr>
            <td>4C</td>
            <td>0000</td>
            <td></td>
            <td></td>
        </tr>

    </tbody>
</table>

Если команды этой программы занести в память базовой ЭВМ, установить в СК пусковой адрес 20 и нажать кнопку ПУСК, то начнет выполняться бесконечный цикл наращивания содержимого аккумулятора. Когда же на пульте управления (рис 1.1) будет нажата любая из трех кнопок ("Готов" ВУ1, ВУ2 или ВУ3), то будет выполнен переход к подпрограмме обработки прерываний. Она может быть построена по стандартной схеме (как в таблице) или в другой форме, учитывающий конкретные особенности реализуемой задачи.
